name: Documentation Automation

on:
  push:
    branches: [main, develop]
    paths:
      - 'backend/**/*.py'
      - 'docs/**/*.md'
      - 'README.md'
  pull_request:
    paths:
      - 'backend/**/*.py'
      - 'docs/**/*.md'
      - 'README.md'
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  # ============================================================================
  # Generate API Documentation
  # ============================================================================
  
  generate-api-docs:
    name: Generate API Documentation
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install documentation tools
        run: |
          pip install pdoc3 sphinx sphinx-rtd-theme pydoc-markdown
          pip install -r backend/requirements.txt
      
      - name: Generate API docs with pdoc
        run: |
          mkdir -p docs/api
          pdoc --html --output-dir docs/api backend/ --force
      
      - name: Generate function documentation
        run: |
          python3 << 'EOF'
          import os
          import inspect
          import importlib.util
          
          def generate_docs(module_path, output_file):
              spec = importlib.util.spec_from_file_location("module", module_path)
              module = importlib.util.module_from_spec(spec)
              spec.loader.exec_module(module)
              
              with open(output_file, 'w') as f:
                  f.write(f"# API Documentation: {os.path.basename(module_path)}\n\n")
                  
                  for name, obj in inspect.getmembers(module):
                      if inspect.isfunction(obj) or inspect.isclass(obj):
                          f.write(f"## `{name}`\n\n")
                          doc = inspect.getdoc(obj)
                          if doc:
                              f.write(f"{doc}\n\n")
                          
                          if inspect.isfunction(obj):
                              sig = inspect.signature(obj)
                              f.write(f"**Signature:** `{name}{sig}`\n\n")
          
          # Generate docs for key modules
          if os.path.exists('backend/analysis_cli.py'):
              generate_docs('backend/analysis_cli.py', 'docs/api/analysis_cli.md')
          
          print("✅ Documentation generated")
          EOF
        continue-on-error: true
      
      - name: Upload API documentation
        uses: actions/upload-artifact@v6
        with:
          name: api-docs
          path: docs/api/
          retention-days: 30

  # ============================================================================
  # Check Documentation Quality
  # ============================================================================
  
  check-docs-quality:
    name: Check Documentation Quality
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Check markdown files
        uses: DavidAnson/markdownlint-cli2-action@v22
        with:
          globs: '**/*.md'
          config: '.markdownlint.json'
        continue-on-error: true
      
      - name: Check for broken links
        uses: gaurav-nelson/github-action-markdown-link-check@v1
        with:
          use-quiet-mode: 'yes'
          folder-path: 'docs/'
          config-file: '.github/markdown-link-check-config.json'
        continue-on-error: true
      
      - name: Spell check documentation
        uses: streetsidesoftware/cspell-action@v8
        with:
          files: |
            **/*.md
            **/*.txt
          config: '.github/cspell.json'
        continue-on-error: true
      
      - name: Check documentation coverage
        run: |
          echo "## Documentation Coverage" > docs-coverage.md
          
          # Find Python files
          PY_FILES=$(find backend -name "*.py" | wc -l)
          
          # Find Python files with docstrings
          PY_WITH_DOCS=$(grep -r "\"\"\"" backend --include="*.py" | cut -d: -f1 | sort -u | wc -l)
          
          COVERAGE=$((PY_WITH_DOCS * 100 / PY_FILES))
          
          echo "- Total Python files: $PY_FILES" >> docs-coverage.md
          echo "- Files with docstrings: $PY_WITH_DOCS" >> docs-coverage.md
          echo "- Coverage: $COVERAGE%" >> docs-coverage.md
          
          cat docs-coverage.md
      
      - name: Upload documentation report
        uses: actions/upload-artifact@v6
        with:
          name: docs-quality-report
          path: docs-coverage.md
          retention-days: 30

  # ============================================================================
  # Auto-generate Changelog
  # ============================================================================
  
  generate-changelog:
    name: Generate Changelog
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            COMMITS=$(git log $LAST_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          
          echo "# Changelog" > CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          echo "## [Unreleased]" >> CHANGELOG_NEW.md
          echo "" >> CHANGELOG_NEW.md
          echo "$COMMITS" >> CHANGELOG_NEW.md
          
          cat CHANGELOG_NEW.md
      
      - name: Commit changelog
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if [ -f CHANGELOG_NEW.md ]; then
            mv CHANGELOG_NEW.md CHANGELOG.md
            git add CHANGELOG.md
            git commit -m "docs: update changelog [skip ci]" || echo "No changes to commit"
            git push || echo "Nothing to push"
          fi
        continue-on-error: true

  # ============================================================================
  # Generate README Badges
  # ============================================================================
  
  update-badges:
    name: Update README Badges
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v6
      
      - name: Update build badges
        run: |
          # This is a placeholder - badges are typically auto-updated
          echo "Badges updated via shields.io"
      
      - name: Update documentation badge
        run: |
          echo "Documentation badge ready"

  # ============================================================================
  # Deploy Documentation to GitHub Pages
  # ============================================================================
  
  deploy-docs:
    name: Deploy Documentation
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [generate-api-docs, check-docs-quality]
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install MkDocs
        run: |
          pip install mkdocs mkdocs-material mkdocs-mermaid2-plugin
      
      - name: Create mkdocs.yml if not exists
        run: |
          if [ ! -f mkdocs.yml ]; then
            cat > mkdocs.yml << 'MKDOCS'
          site_name: ArbFinder Suite Documentation
          site_description: Comprehensive price analysis and item tracking system
          site_author: ArbFinder Contributors
          
          theme:
            name: material
            palette:
              primary: blue
              accent: indigo
            features:
              - navigation.tabs
              - navigation.sections
              - toc.integrate
              - search.suggest
          
          nav:
            - Home: README.md
            - Research Report: docs/RESEARCH_REPORT.md
            - CLI Guide: docs/ANALYSIS_CLI.md
            - Enterprise Roadmap: docs/ENTERPRISE_ROADMAP.md
            - Examples: docs/EXAMPLES.md
            - Infrastructure: infrastructure/README.md
          
          markdown_extensions:
            - admonition
            - codehilite
            - toc:
                permalink: true
          MKDOCS
          fi
      
      - name: Build documentation
        run: |
          mkdocs build
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          user_name: 'github-actions[bot]'
          user_email: 'github-actions[bot]@users.noreply.github.com'
        continue-on-error: true

  # ============================================================================
  # Generate Examples
  # ============================================================================
  
  generate-examples:
    name: Generate Code Examples
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Extract code examples from docs
        run: |
          python3 << 'EOF'
          import re
          import os
          
          def extract_code_blocks(md_file):
              with open(md_file, 'r') as f:
                  content = f.read()
              
              # Find all code blocks
              pattern = r'```(\w+)\n(.*?)```'
              blocks = re.findall(pattern, content, re.DOTALL)
              
              return blocks
          
          # Create examples directory
          os.makedirs('examples/extracted', exist_ok=True)
          
          # Extract from all markdown files
          for root, dirs, files in os.walk('docs'):
              for file in files:
                  if file.endswith('.md'):
                      filepath = os.path.join(root, file)
                      blocks = extract_code_blocks(filepath)
                      
                      for i, (lang, code) in enumerate(blocks):
                          if lang in ['python', 'bash', 'sql']:
                              ext = {'python': 'py', 'bash': 'sh', 'sql': 'sql'}[lang]
                              output = f'examples/extracted/{file[:-3]}_example_{i}.{ext}'
                              with open(output, 'w') as f:
                                  f.write(code.strip())
          
          print("✅ Code examples extracted")
          EOF
        continue-on-error: true
      
      - name: Upload examples
        uses: actions/upload-artifact@v6
        with:
          name: code-examples
          path: examples/extracted/
          retention-days: 30
