name: Dependency Management

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
  pull_request:
    paths:
      - 'backend/requirements.txt'
      - 'frontend/package.json'
      - 'frontend/package-lock.json'

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  # ============================================================================
  # Check for Outdated Dependencies
  # ============================================================================
  
  check-outdated-python:
    name: Check Outdated Python Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -r backend/requirements.txt
          pip install pip-check-updates
      
      - name: Check for updates
        id: outdated
        run: |
          pip list --outdated --format=json > outdated-python.json
          pip list --outdated
          
          COUNT=$(cat outdated-python.json | jq 'length')
          echo "count=$COUNT" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Upload outdated report
        uses: actions/upload-artifact@v4
        with:
          name: outdated-python-deps
          path: outdated-python.json
          retention-days: 30
      
      - name: Create issue for outdated dependencies
        if: steps.outdated.outputs.count > 0
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const outdated = JSON.parse(fs.readFileSync('outdated-python.json', 'utf8'));
            
            let body = '## Outdated Python Dependencies\n\n';
            body += 'The following dependencies have available updates:\n\n';
            body += '| Package | Current | Latest |\n';
            body += '|---------|---------|--------|\n';
            
            for (const pkg of outdated) {
              body += `| ${pkg.name} | ${pkg.version} | ${pkg.latest_version} |\n`;
            }
            
            body += '\n**Action Required:** Review and update dependencies as needed.\n';
            
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'dependencies,python'
            });
            
            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üîÑ Update Python Dependencies',
                body: body,
                labels: ['dependencies', 'python', 'maintenance']
              });
            }

  check-outdated-npm:
    name: Check Outdated NPM Dependencies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Install dependencies
        run: |
          cd frontend
          npm ci
      
      - name: Check for updates
        id: outdated
        run: |
          cd frontend
          npm outdated --json > ../outdated-npm.json || true
          npm outdated || true
          
          COUNT=$(cat ../outdated-npm.json | jq 'keys | length')
          echo "count=$COUNT" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Upload outdated report
        uses: actions/upload-artifact@v4
        with:
          name: outdated-npm-deps
          path: outdated-npm.json
          retention-days: 30

  # ============================================================================
  # Auto-update Dependencies
  # ============================================================================
  
  auto-update-dependencies:
    name: Auto-update Dependencies
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Update Python dependencies
        run: |
          pip install pip-tools
          pip-compile --upgrade backend/requirements.txt
        continue-on-error: true
      
      - name: Update NPM dependencies
        run: |
          cd frontend
          npm update
          npm audit fix || true
        continue-on-error: true
      
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: update dependencies'
          title: 'üîÑ Automated Dependency Updates'
          body: |
            ## Automated Dependency Updates
            
            This PR contains automated dependency updates.
            
            ### Changes
            - Updated Python dependencies to latest compatible versions
            - Updated NPM dependencies to latest compatible versions
            - Fixed known security vulnerabilities
            
            ### Testing Required
            - [ ] Backend tests pass
            - [ ] Frontend tests pass
            - [ ] Integration tests pass
            - [ ] Manual testing completed
            
            **Note:** Review all changes carefully before merging.
          branch: automated/dependency-updates
          delete-branch: true
          labels: |
            dependencies
            automated
            maintenance

  # ============================================================================
  # Dependency Vulnerability Check
  # ============================================================================
  
  check-vulnerabilities:
    name: Check for Vulnerabilities
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check Python vulnerabilities
        run: |
          pip install safety
          pip install -r backend/requirements.txt
          safety check --json --output python-vulns.json
          safety check || true
        continue-on-error: true
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
      
      - name: Check NPM vulnerabilities
        run: |
          cd frontend
          npm ci
          npm audit --json > ../npm-vulns.json || true
          npm audit || true
        continue-on-error: true
      
      - name: Upload vulnerability reports
        uses: actions/upload-artifact@v4
        with:
          name: vulnerability-reports
          path: |
            python-vulns.json
            npm-vulns.json
          retention-days: 90
      
      - name: Create security issue if vulnerabilities found
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let hasCritical = false;
            let body = '## Security Vulnerabilities Detected\n\n';
            
            try {
              const pythonVulns = JSON.parse(fs.readFileSync('python-vulns.json', 'utf8'));
              if (pythonVulns.vulnerabilities && pythonVulns.vulnerabilities.length > 0) {
                hasCritical = true;
                body += '### Python Dependencies\n';
                for (const vuln of pythonVulns.vulnerabilities) {
                  body += `- **${vuln.package}** (${vuln.installed_version}): ${vuln.vulnerability}\n`;
                }
              }
            } catch (e) {}
            
            try {
              const npmVulns = JSON.parse(fs.readFileSync('npm-vulns.json', 'utf8'));
              if (npmVulns.metadata && npmVulns.metadata.vulnerabilities) {
                const counts = npmVulns.metadata.vulnerabilities;
                if (counts.critical > 0 || counts.high > 0) {
                  hasCritical = true;
                  body += '\n### NPM Dependencies\n';
                  body += `- Critical: ${counts.critical}\n`;
                  body += `- High: ${counts.high}\n`;
                  body += `- Moderate: ${counts.moderate}\n`;
                  body += `- Low: ${counts.low}\n`;
                }
              }
            } catch (e) {}
            
            if (hasCritical) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'üö® Security Vulnerabilities Detected',
                body: body,
                labels: ['security', 'dependencies', 'critical']
              });
            }
        continue-on-error: true

  # ============================================================================
  # License Compliance
  # ============================================================================
  
  check-licenses:
    name: Check License Compliance
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Check Python licenses
        run: |
          pip install pip-licenses
          pip install -r backend/requirements.txt
          pip-licenses --format=json --output-file=python-licenses.json
          pip-licenses --summary
          
          # Check for problematic licenses
          pip-licenses | grep -iE "GPL|AGPL|SSPL" && echo "‚ö†Ô∏è Potentially problematic licenses found" || echo "‚úÖ No problematic licenses"
        continue-on-error: true
      
      - name: Upload license reports
        uses: actions/upload-artifact@v4
        with:
          name: license-reports
          path: python-licenses.json
          retention-days: 90

  # ============================================================================
  # Renovate Bot Configuration Check
  # ============================================================================
  
  check-renovate-config:
    name: Validate Renovate Config
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate renovate.json
        if: hashFiles('renovate.json') != ''
        uses: rinchsan/renovate-config-validator@v0.0.12
        with:
          pattern: 'renovate.json'
