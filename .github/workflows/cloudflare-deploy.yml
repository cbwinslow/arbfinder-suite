name: Deploy to Cloudflare

on:
  push:
    branches:
      - main
      - staging
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
          - preview

permissions:
  contents: read
  deployments: write

env:
  NODE_VERSION: '18'

jobs:
  # ============================================================================
  # Deploy Worker
  # ============================================================================
  
  deploy-worker:
    name: Deploy Cloudflare Worker
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: cloudflare/package-lock.json
      
      - name: Install Worker dependencies
        working-directory: cloudflare
        run: npm ci
      
      - name: Deploy Worker to Cloudflare
        working-directory: cloudflare
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            npx wrangler deploy --env production
          else
            npx wrangler deploy --env staging
          fi
      
      - name: Get Worker URL
        id: worker-url
        working-directory: cloudflare
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "url=https://arbfinder-worker.your-domain.workers.dev" >> $GITHUB_OUTPUT
          else
            echo "url=https://arbfinder-worker-staging.your-domain.workers.dev" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment Worker URL on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸš€ **Worker Deployed!**\n\nWorker URL: ${{ steps.worker-url.outputs.url }}'
            })

  # ============================================================================
  # Deploy Pages
  # ============================================================================
  
  deploy-pages:
    name: Deploy Cloudflare Pages
    runs-on: ubuntu-latest
    needs: deploy-worker
    environment:
      name: ${{ github.event.inputs.environment || (github.ref == 'refs/heads/main' && 'production' || 'staging') }}
    outputs:
      deployment-url: ${{ steps.deploy.outputs.url }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json
      
      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci
      
      - name: Configure Next.js for static export
        working-directory: frontend
        run: |
          cat > next.config.js << 'EOF'
          /** @type {import('next').NextConfig} */
          const nextConfig = {
            reactStrictMode: true,
            output: 'export',
            images: {
              unoptimized: true,
            },
            trailingSlash: true,
          };
          
          module.exports = nextConfig;
          EOF
      
      - name: Set API base URL
        working-directory: frontend
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            echo "NEXT_PUBLIC_API_BASE=https://arbfinder-worker.your-domain.workers.dev" > .env.production
          else
            echo "NEXT_PUBLIC_API_BASE=https://arbfinder-worker-staging.your-domain.workers.dev" > .env.production
          fi
      
      - name: Build frontend
        working-directory: frontend
        run: npm run build
      
      - name: Deploy to Cloudflare Pages
        id: deploy
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: arbfinder-suite
          directory: frontend/out
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref_name }}
      
      - name: Comment deployment URL on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: 'ðŸŽ‰ **Pages Deployed!**\n\nDeployment URL: ${{ steps.deploy.outputs.url }}\n\nPreview your changes before merging.'
            })
      
      - name: Create deployment status
        if: github.event_name == 'push'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'success',
              environment_url: '${{ steps.deploy.outputs.url }}',
              description: 'Deployed to Cloudflare Pages'
            })

  # ============================================================================
  # Verify Deployment
  # ============================================================================
  
  verify-deployment:
    name: Verify Deployment
    runs-on: ubuntu-latest
    needs: [deploy-worker, deploy-pages]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
      
      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: ${{ env.NODE_VERSION }}
      
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq bc
      
      - name: Wait for deployment to be ready
        run: sleep 30
      
      - name: Test Worker health endpoint
        run: |
          if [ "${{ github.ref }}" == "refs/heads/main" ]; then
            WORKER_URL="https://arbfinder-worker.your-domain.workers.dev"
          else
            WORKER_URL="https://arbfinder-worker-staging.your-domain.workers.dev"
          fi
          
          echo "Testing Worker health endpoint: $WORKER_URL/api/health"
          
          response=$(curl -s -w "\n%{http_code}" "$WORKER_URL/api/health" || echo "000")
          status=$(echo "$response" | tail -n 1)
          
          if [ "$status" == "200" ]; then
            echo "âœ“ Worker health check passed"
          else
            echo "âœ— Worker health check failed (HTTP $status)"
            exit 1
          fi
      
      - name: Test Pages deployment
        run: |
          PAGES_URL="${{ needs.deploy-pages.outputs.deployment-url }}"
          
          if [ -z "$PAGES_URL" ]; then
            echo "âš  Pages URL not available, skipping test"
            exit 0
          fi
          
          echo "Testing Pages deployment: $PAGES_URL"
          
          status=$(curl -s -o /dev/null -w "%{http_code}" "$PAGES_URL" || echo "000")
          
          if [ "$status" == "200" ]; then
            echo "âœ“ Pages deployment accessible"
          else
            echo "âœ— Pages deployment not accessible (HTTP $status)"
            exit 1
          fi
      
      - name: Run comprehensive verification
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          # Create temporary config file
          cat > .cloudflare-config.json << EOF
          {
            "worker_url": "https://arbfinder-worker.your-domain.workers.dev",
            "pages_url": "${{ needs.deploy-pages.outputs.deployment-url }}",
            "worker_name": "arbfinder-worker",
            "pages_project": "arbfinder-suite"
          }
          EOF
          
          # Make script executable and run
          chmod +x scripts/cloudflare/verify_deployment.sh
          ./scripts/cloudflare/verify_deployment.sh || true

  # ============================================================================
  # Notify Deployment
  # ============================================================================
  
  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [deploy-worker, deploy-pages, verify-deployment]
    if: always()
    steps:
      - name: Deployment Success
        if: needs.verify-deployment.result == 'success'
        run: |
          echo "âœ“ Deployment completed successfully!"
          echo "Pages URL: ${{ needs.deploy-pages.outputs.deployment-url }}"
      
      - name: Deployment Failed
        if: needs.verify-deployment.result == 'failure'
        run: |
          echo "âœ— Deployment failed. Please check the logs."
          exit 1

# Note: Before using this workflow, set the following secrets in your repository:
# - CLOUDFLARE_API_TOKEN: Your Cloudflare API token
# - CLOUDFLARE_ACCOUNT_ID: Your Cloudflare account ID
#
# These can be set at: https://github.com/YOUR_USERNAME/YOUR_REPO/settings/secrets/actions
