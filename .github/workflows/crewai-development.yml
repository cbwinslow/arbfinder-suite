name: CrewAI Software Development

on:
  schedule:
    # Run weekly on Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      task:
        description: 'Development task'
        required: true
        type: string
      priority:
        description: 'Task priority'
        required: false
        type: choice
        options:
          - low
          - medium
          - high
          - critical

permissions:
  contents: write
  pull-requests: write
  issues: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================================================
  # Run CrewAI Development Crew
  # ============================================================================
  
  crewai-development:
    name: CrewAI Development Crew
    runs-on: ubuntu-latest
    outputs:
      task-completed: ${{ steps.crew.outputs.completed }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev,test]"
      
      - name: Run CrewAI development crew
        id: crew
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 scripts/crewai_dev_crew.py \
            --task "${{ github.event.inputs.task || 'Review and improve codebase' }}" \
            --priority "${{ github.event.inputs.priority || 'medium' }}" \
            --output crew-output.json
          
          if [ $? -eq 0 ]; then
            echo "completed=true" >> $GITHUB_OUTPUT
          else
            echo "completed=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Upload crew output
        uses: actions/upload-artifact@v4
        with:
          name: crew-output
          path: crew-output.json
          retention-days: 30

  # ============================================================================
  # Code Research Agent
  # ============================================================================
  
  research-agent:
    name: Code Research Agent
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev,test]"
      
      - name: Run research agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 scripts/research_agent.py \
            --topic "code improvements" \
            --output research-report.md
        continue-on-error: true
      
      - name: Upload research report
        uses: actions/upload-artifact@v4
        with:
          name: research-report
          path: research-report.md
          retention-days: 30

  # ============================================================================
  # Code Implementation Agent
  # ============================================================================
  
  implementation-agent:
    name: Code Implementation Agent
    runs-on: ubuntu-latest
    needs: research-agent
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev,test]"
      
      - name: Download research report
        uses: actions/download-artifact@v4
        with:
          name: research-report
      
      - name: Run implementation agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 scripts/implementation_agent.py \
            --research research-report.md \
            --target backend/
        continue-on-error: true
      
      - name: Run tests
        run: |
          pytest tests/ -v
        continue-on-error: true
      
      - name: Commit changes
        run: |
          git config user.name "crewai-bot[bot]"
          git config user.email "crewai-bot[bot]@users.noreply.github.com"
          git add -A
          git commit -m "feat: AI agent implementation" || echo "No changes to commit"
        continue-on-error: true

  # ============================================================================
  # Testing Agent
  # ============================================================================
  
  testing-agent:
    name: Testing Agent
    runs-on: ubuntu-latest
    needs: implementation-agent
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev,test]"
      
      - name: Run testing agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 scripts/testing_agent.py \
            --source backend/ \
            --output tests/ \
            --coverage-target 80
        continue-on-error: true
      
      - name: Run generated tests
        run: |
          pytest tests/ -v --cov=backend --cov-report=term
        continue-on-error: true
      
      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: htmlcov/
          retention-days: 7

  # ============================================================================
  # Review Agent
  # ============================================================================
  
  review-agent:
    name: Review Agent
    runs-on: ubuntu-latest
    needs: [implementation-agent, testing-agent]
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
      
      - name: Install dependencies
        run: |
          pip install -e ".[dev,test]"
      
      - name: Run review agent
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python3 scripts/review_agent.py \
            --target backend/ \
            --output review-report.md
        continue-on-error: true
      
      - name: Upload review report
        uses: actions/upload-artifact@v4
        with:
          name: review-report
          path: review-report.md
          retention-days: 30
      
      - name: Comment on issues
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('review-report.md')) {
              const review = fs.readFileSync('review-report.md', 'utf8');
              
              // Create a new issue with the review
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: 'ü§ñ CrewAI Weekly Code Review',
                body: review,
                labels: ['crewai', 'automated-review', 'enhancement']
              });
            }
        continue-on-error: true

  # ============================================================================
  # Create Development PR
  # ============================================================================
  
  create-development-pr:
    name: Create Development PR
    runs-on: ubuntu-latest
    needs: [crewai-development, implementation-agent, testing-agent, review-agent]
    if: always()
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        continue-on-error: true
      
      - name: Create PR with CrewAI improvements
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat: CrewAI automated development improvements"
          title: "ü§ñ CrewAI Development Improvements"
          body: |
            ## CrewAI Automated Development
            
            This PR contains improvements from the CrewAI development crew:
            
            ### Agents Involved
            - üîç Research Agent: Analyzed codebase and best practices
            - üíª Implementation Agent: Applied improvements
            - üß™ Testing Agent: Generated comprehensive tests
            - üëÄ Review Agent: Reviewed all changes
            
            ### Improvements
            - Code quality enhancements
            - New tests added
            - Documentation updated
            - Performance optimizations
            
            ### Reports
            See attached artifacts for detailed reports from each agent.
          branch: crewai-improvements-${{ github.run_number }}
          labels: |
            crewai
            automated
            enhancement
