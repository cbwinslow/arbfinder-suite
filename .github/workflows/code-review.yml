name: Code Review Automation

on:
  pull_request:
    types: [opened, synchronize, reopened]
  pull_request_review:
    types: [submitted]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  # ============================================================================
  # Automated Code Review
  # ============================================================================
  
  automated-review:
    name: Automated Code Review
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install review tools
        run: |
          pip install radon mccabe vulture pyflakes
          pip install -r backend/requirements.txt
      
      - name: Analyze code complexity
        id: complexity
        run: |
          echo "## Code Complexity Analysis" > complexity-report.md
          echo "" >> complexity-report.md
          radon cc backend/ -a -s -j > complexity.json || true
          radon cc backend/ -a -s >> complexity-report.md || true
          echo "" >> complexity-report.md
          echo "### Maintainability Index" >> complexity-report.md
          radon mi backend/ -s >> complexity-report.md || true
        continue-on-error: true
      
      - name: Find dead code
        id: deadcode
        run: |
          echo "## Dead Code Detection" > deadcode-report.md
          echo "" >> deadcode-report.md
          vulture backend/ --min-confidence 80 >> deadcode-report.md || true
        continue-on-error: true
      
      - name: Check code duplication
        run: |
          pip install pylint
          echo "## Code Duplication" > duplication-report.md
          pylint backend/ --disable=all --enable=duplicate-code >> duplication-report.md || true
        continue-on-error: true
      
      - name: Upload review reports
        uses: actions/upload-artifact@v6
        with:
          name: code-review-reports
          path: |
            complexity-report.md
            deadcode-report.md
            duplication-report.md
          retention-days: 30

  # ============================================================================
  # PR Size Check
  # ============================================================================
  
  pr-size-check:
    name: PR Size Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Check PR size
        id: pr-size
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          ADDITIONS=$(git diff --shortstat $BASE_SHA..$HEAD_SHA | grep -oP '\d+(?= insertion)')
          DELETIONS=$(git diff --shortstat $BASE_SHA..$HEAD_SHA | grep -oP '\d+(?= deletion)')
          FILES_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | wc -l)
          
          ADDITIONS=${ADDITIONS:-0}
          DELETIONS=${DELETIONS:-0}
          TOTAL_CHANGES=$((ADDITIONS + DELETIONS))
          
          echo "additions=$ADDITIONS" >> $GITHUB_OUTPUT
          echo "deletions=$DELETIONS" >> $GITHUB_OUTPUT
          echo "files=$FILES_CHANGED" >> $GITHUB_OUTPUT
          echo "total=$TOTAL_CHANGES" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š PR Statistics:"
          echo "- Files changed: $FILES_CHANGED"
          echo "- Lines added: $ADDITIONS"
          echo "- Lines deleted: $DELETIONS"
          echo "- Total changes: $TOTAL_CHANGES"
      
      - name: Label PR based on size
        uses: actions/github-script@v8
        with:
          script: |
            const total = ${{ steps.pr-size.outputs.total }};
            const files = ${{ steps.pr-size.outputs.files }};
            
            let sizeLabel = '';
            if (total < 100) sizeLabel = 'size/XS';
            else if (total < 300) sizeLabel = 'size/S';
            else if (total < 1000) sizeLabel = 'size/M';
            else if (total < 3000) sizeLabel = 'size/L';
            else sizeLabel = 'size/XL';
            
            // Remove old size labels
            const labels = ['size/XS', 'size/S', 'size/M', 'size/L', 'size/XL'];
            for (const label of labels) {
              try {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: label
                });
              } catch (error) {
                // Label doesn't exist, ignore
              }
            }
            
            // Add new size label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [sizeLabel]
            });
            
            // Comment if PR is too large
            if (total > 1000) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `âš ï¸ **Large PR Detected**\n\nThis PR has ${total} line changes across ${files} files. Consider breaking it into smaller, focused PRs for easier review.`
              });
            }

  # ============================================================================
  # Code Coverage Check
  # ============================================================================
  
  coverage-check:
    name: Code Coverage Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install -e ".[test]"
      
      - name: Run tests with coverage
        run: |
          pytest tests/ --cov=backend --cov-report=json --cov-report=term
        continue-on-error: true
      
      - name: Check coverage threshold
        id: coverage
        run: |
          COVERAGE=$(python -c "import json; print(json.load(open('coverage.json'))['totals']['percent_covered'])")
          echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
          echo "Current coverage: $COVERAGE%"
          
          if (( $(echo "$COVERAGE < 70" | bc -l) )); then
            echo "âš ï¸  Coverage below 70%"
            echo "status=warning" >> $GITHUB_OUTPUT
          else
            echo "âœ… Coverage acceptable"
            echo "status=success" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Comment coverage on PR
        uses: actions/github-script@v8
        if: steps.coverage.outputs.coverage
        with:
          script: |
            const coverage = ${{ steps.coverage.outputs.coverage }};
            const status = '${{ steps.coverage.outputs.status }}';
            
            const emoji = status === 'success' ? 'âœ…' : 'âš ï¸';
            const message = `${emoji} **Code Coverage: ${coverage}%**`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: message
            });

  # ============================================================================
  # Breaking Changes Detection
  # ============================================================================
  
  breaking-changes:
    name: Breaking Changes Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Detect API breaking changes
        id: breaking
        run: |
          # Check for removed functions/classes
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          echo "checking=true" >> $GITHUB_OUTPUT
          
          # Check for removed public functions
          git diff $BASE_SHA..$HEAD_SHA -- '*.py' | grep -E "^-def [a-zA-Z]" > removed_functions.txt || true
          
          if [ -s removed_functions.txt ]; then
            echo "breaking=true" >> $GITHUB_OUTPUT
            echo "âš ï¸  Potential breaking changes detected"
            cat removed_functions.txt
          else
            echo "breaking=false" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Label if breaking changes detected
        if: steps.breaking.outputs.breaking == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['breaking-change']
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'âš ï¸ **Breaking Changes Detected**\n\nThis PR may contain breaking changes. Please review carefully and update the changelog.'
            });

  # ============================================================================
  # Documentation Check
  # ============================================================================
  
  docs-check:
    name: Documentation Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      
      - name: Check if docs need update
        id: docs
        run: |
          BASE_SHA=${{ github.event.pull_request.base.sha }}
          HEAD_SHA=${{ github.event.pull_request.head.sha }}
          
          # Check if Python files changed
          PYTHON_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep -E '\.py$' | wc -l)
          
          # Check if docs changed
          DOCS_CHANGED=$(git diff --name-only $BASE_SHA..$HEAD_SHA | grep -E 'docs/.*\.md$|README\.md' | wc -l)
          
          echo "python_changed=$PYTHON_CHANGED" >> $GITHUB_OUTPUT
          echo "docs_changed=$DOCS_CHANGED" >> $GITHUB_OUTPUT
          
          if [ "$PYTHON_CHANGED" -gt 5 ] && [ "$DOCS_CHANGED" -eq 0 ]; then
            echo "needs_docs=true" >> $GITHUB_OUTPUT
          else
            echo "needs_docs=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Suggest documentation update
        if: steps.docs.outputs.needs_docs == 'true'
        uses: actions/github-script@v8
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['needs-docs']
            });
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: 'ðŸ“ **Documentation Update Suggested**\n\nThis PR modifies several Python files but doesn\'t update documentation. Consider updating relevant docs in the `docs/` directory.'
            });

  # ============================================================================
  # Auto-assign Reviewers
  # ============================================================================
  
  auto-assign:
    name: Auto-assign Reviewers
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - uses: actions/checkout@v6
      
      - name: Auto-assign based on changed files
        uses: actions/github-script@v8
        with:
          script: |
            const files = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const fileNames = files.data.map(f => f.filename);
            const reviewers = new Set();
            
            // Add reviewers based on file patterns
            if (fileNames.some(f => f.startsWith('backend/'))) {
              reviewers.add('backend-team');
            }
            if (fileNames.some(f => f.startsWith('frontend/'))) {
              reviewers.add('frontend-team');
            }
            if (fileNames.some(f => f.includes('database') || f.endsWith('.sql'))) {
              reviewers.add('database-team');
            }
            if (fileNames.some(f => f.startsWith('docs/'))) {
              reviewers.add('docs-team');
            }
            
            // Note: This will only work if these teams exist
            // You can replace with actual usernames
            console.log('Suggested reviewers:', Array.from(reviewers));
